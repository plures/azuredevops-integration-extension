# Git Worktree Configuration Guide

**Version**: 1.0  
**Effective Date**: 2025-01-27  
**Status**: Active

---

## Overview

This project uses Git worktrees to enable parallel development across multiple branches. This guide explains how to configure and use worktrees effectively with this project.

---

## Current Worktree Setup

### Main Repository
- **Location**: `C:/Projects/azuredevops-integration-extension`
- **Branch**: `main`
- **Purpose**: Primary development repository

### Worktree Locations
- **Pattern**: `C:/Users/kayod/.cursor/worktrees/azuredevops-integration-extension/<worktree-id>`
- **Purpose**: Isolated workspaces for feature branches

---

## Worktree Benefits

1. **Parallel Development**: Work on multiple features simultaneously
2. **Isolated Environments**: Each worktree has its own working directory
3. **Fast Switching**: No need to stash/unstash when switching branches
4. **Cursor Integration**: Cursor automatically creates worktrees for branches

---

## Worktree Commands

### List All Worktrees

```bash
git worktree list
```

Output example:
```
C:/Projects/azuredevops-integration-extension             ceffd73 [main]
C:/Users/kayod/.cursor/worktrees/.../2vb5S               ceffd73 [2025-11-07-f938-2vb5S]
C:/Users/kayod/.cursor/worktrees/.../AgqGn               ceffd73 [docs-arch-error-checklist-AgqGn]
C:/Users/kayod/.cursor/worktrees/.../TMe0p               ceffd73 [chore-update-checklist-TMe0p]
```

### Create New Worktree

```bash
# From main repository
cd C:/Projects/azuredevops-integration-extension

# Create worktree for new feature branch
git worktree add ../worktrees/azuredevops-integration-extension/feat-123-my-feature -b feat/123-my-feature

# Or for existing branch
git worktree add ../worktrees/azuredevops-integration-extension/feat-123-my-feature feat/123-my-feature
```

### Remove Worktree

```bash
# From main repository
cd C:/Projects/azuredevops-integration-extension

# Remove worktree (deletes branch files but keeps branch in git)
git worktree remove ../worktrees/azuredevops-integration-extension/feat-123-my-feature

# Force remove if worktree has uncommitted changes
git worktree remove --force ../worktrees/azuredevops-integration-extension/feat-123-my-feature
```

### Prune Stale Worktrees

```bash
# Remove worktrees that no longer exist on disk
git worktree prune
```

---

## Cursor Integration

Cursor automatically creates worktrees when you:
1. Checkout a branch in Cursor
2. Create a new branch from Cursor
3. Switch between branches

### Cursor Worktree Pattern

Cursor creates worktrees in:
```
C:/Users/kayod/.cursor/worktrees/azuredevops-integration-extension/<unique-id>
```

The unique ID is generated by Cursor and may not match the branch name.

### Finding Your Worktree

```bash
# List all worktrees with their branches
git worktree list

# Find current worktree location
git rev-parse --git-dir
# Output: C:/Projects/azuredevops-integration-extension/.git/worktrees/TMe0p
```

---

## Best Practices

### 1. Worktree Organization

- **Main repo**: Use for `main` branch only
- **Feature worktrees**: One worktree per feature branch
- **Clean up**: Remove worktrees after merging PRs

### 2. Branch Naming

Follow the project's branch naming convention:
- `feat/<issue>-<description>`
- `fix/<issue>-<description>`
- `refactor/<issue>-<description>`
- `docs/<issue>-<description>`

### 3. Worktree Cleanup

```bash
# Regular cleanup script
git worktree prune

# Remove merged branches
git branch --merged main | grep -v "\*\|main\|develop" | xargs -n 1 git branch -d

# Remove worktrees for deleted branches
# (Manual: check each worktree and remove if branch is gone)
```

### 4. Avoiding Conflicts

- **One worktree per branch**: Don't create multiple worktrees for the same branch
- **Sync before creating**: `git fetch origin` before creating new worktree
- **Update regularly**: `git pull` in each worktree to stay current

---

## Configuration

### Git Config for Worktrees

Add to your global `.gitconfig` or repository `.git/config`:

```ini
[worktree]
    # Automatically prune stale worktrees
    prune = true

[core]
    # Prevent accidental commits to wrong branch
    hooksPath = .git/hooks

[alias]
    # List worktrees with more detail
    wt = worktree list
    wt-add = worktree add
    wt-remove = worktree remove
    wt-prune = worktree prune
```

### VS Code Settings

If using VS Code in worktrees, ensure settings are shared:

```json
{
  "files.watcherExclude": {
    "**/.git/worktrees/**": true
  },
  "search.exclude": {
    "**/.git/worktrees/**": true
  }
}
```

---

## Troubleshooting

### Issue: "Worktree is locked"

**Solution**:
```bash
# Remove lock file
rm .git/worktrees/<worktree-id>/locked

# Or force remove
git worktree remove --force <path>
```

### Issue: "Branch already checked out"

**Solution**:
```bash
# Find which worktree has the branch
git worktree list

# Either:
# 1. Use that worktree
# 2. Remove the worktree if done
# 3. Create worktree with different branch name
```

### Issue: "Worktree path not found"

**Solution**:
```bash
# Prune stale worktrees
git worktree prune

# Verify worktree exists
git worktree list
```

### Issue: "Cannot create worktree: path already exists"

**Solution**:
```bash
# Remove existing directory or use different path
rm -rf <path>
git worktree add <path> <branch>
```

---

## Workflow Integration

### Starting New Feature

```bash
# 1. Ensure main is up to date
cd C:/Projects/azuredevops-integration-extension
git checkout main
git pull origin main

# 2. Create feature branch worktree
git worktree add ../worktrees/azuredevops-integration-extension/feat-123-my-feature -b feat/123-my-feature

# 3. Work in the worktree
cd ../worktrees/azuredevops-integration-extension/feat-123-my-feature
npm install
npm run build

# 4. Make changes and commit
git add .
git commit -m "feat: implement feature"
```

### After PR Merge

```bash
# 1. Return to main repository
cd C:/Projects/azuredevops-integration-extension

# 2. Update main
git checkout main
git pull origin main

# 3. Remove worktree
git worktree remove ../worktrees/azuredevops-integration-extension/feat-123-my-feature

# 4. Delete branch (if not auto-deleted by GitHub)
git branch -d feat/123-my-feature
git push origin --delete feat/123-my-feature
```

---

## Automation Scripts

### Cleanup Script

Create `scripts/cleanup-worktrees.sh`:

```bash
#!/bin/bash
# Clean up merged worktrees

cd "$(git rev-parse --show-toplevel)"

# Prune stale worktrees
git worktree prune

# List all worktrees
echo "Current worktrees:"
git worktree list

# Prompt to remove each non-main worktree
# (Manual cleanup recommended)
```

### Worktree Status Script

Create `scripts/worktree-status.sh`:

```bash
#!/bin/bash
# Show status of all worktrees

cd "$(git rev-parse --show-toplevel)"

git worktree list | while read line; do
  path=$(echo $line | awk '{print $1}')
  branch=$(echo $line | awk '{print $NF}' | tr -d '[]')
  
  if [ -d "$path" ]; then
    echo "Worktree: $path"
    echo "  Branch: $branch"
    echo "  Status: $(cd "$path" && git status --short | wc -l) uncommitted changes"
    echo ""
  fi
done
```

---

## Security Considerations

1. **Worktree Isolation**: Each worktree has its own `.git` reference, but shares the object database
2. **Permissions**: Ensure worktree directories have appropriate permissions
3. **Cleanup**: Remove worktrees containing sensitive data after use

---

## References

- [Git Worktree Documentation](https://git-scm.com/docs/git-worktree)
- [Project Git Workflow Strategy](./GIT_WORKFLOW_STRATEGY.md)
- [Cursor Worktree Integration](https://cursor.sh/docs)

---

**Status**: Active configuration  
**Last Updated**: 2025-01-27

